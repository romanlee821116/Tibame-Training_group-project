<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=, initial-scale=1.0">
    <link rel="stylesheet" href="../css/login.css">
    <!-- fontawesome -->
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
        integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous" />
    <script src="https://smtpjs.com/v3/smtp.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src='../js/login.js'></script>
    <title>會員登入 - 小春堂</title>
    <link rel="icon" href="../images/index/logo_footer.png">
</head>

<body>
    <div class='loginAll'>
        <div id="loginImg">
            <img src="../images/login/login.png">
        </div>
        <div class='loginSignup'>
            <div class='loginClose'>
                <div class="loginHam loginHamBar1"></div>
                <div class="loginHam loginHamBar2"></div>
                <div class="loginHam loginHamBar3"></div>
            </div>
            <!-- <img class='loginClose' src="../images/login/close.png"> -->
            <div class='loginLeft'>
                <div id='loginTitle' class='loginFormTitle'>
                    <h4 id='loginIcon'>會員登入</h4>
                    <h4 id='signupIcon' class='loginRefresh'>會員註冊</h4>
                    <div class='loginChoosenBar'></div>
                </div>
                <!-- 其他登入方式 -->
                <div class="loginOther">
                    <div class="loginOther1">
                        <p class='loginUnderline'></p>
                        <p>OR</p>
                        <p class='loginUnderline'></p>
                    </div>
                    <div class="loginOther2">
                        <div class="loginFB">
                            <i class="fab fa-facebook-square"></i>
                            <a href="###">使用FaceBook登入</a>
                        </div>
                        <div class="loginLine">
                            <i class="fab fa-line"></i>
                            <a href="###">使用Line登入</a>
                        </div>
                    </div>
                </div>
                <!-- 登入註冊============================= -->
                <div class="loginForm">
                    <form id='loginFormPage' method='POST' action=''>
                        <div class='loginWrapper'>
                            <div id="loginArrow"></div>
                            <div class='loginErrorWrap'>
                                <input class='loginAccount loginWrong' type="text" placeholder="請輸入您的信箱" name='account'>
                                <member-error></member-error>
                            </div>
                            <div class='loginErrorWrap'>
                                <input id='loginPassword' class='psw loginWrong' name='password' type="password"
                                    placeholder="請輸入密碼"><i class="eye eye1 fas fa-eye"></i>
                                <member-error></member-error>
                            </div>
                            <button class='loginButton loginBtn' type='submit' onclick='doLogin()'>
                                登入
                            </button>

                            <div id='loginKeep'>
                                <input type="checkbox" id='loginKeeplog'>
                                <label for="loginKeeplog" class='loginKeeplog'>保持登入</label>
                                <span id='loginForgetPsw'>忘記密碼？</span>
                            </div>
                            <div class='loginErrorWrap'>
                                <input id='loginPassword2' name='password' type="password" placeholder="請再次輸入密碼"><i
                                    class="eye eye2 fas fa-eye"></i>
                                <member-error></member-error>
                            </div>
                            <div class='loginErrorWrap'>
                                <div class='loginGender'>
                                    <input name='loginGender' type="radio" id="loginMale" value='man'>
                                    <label for="loginMale">男性</label>
                                    <input name='loginGender' type="radio" id="loginFemale" value='female'>
                                    <label for="loginFemale">女性</label>
                                    <input name='loginGender' type="radio" id="loginOther" value='other'>
                                    <label for="loginOther">第三性</label>
                                </div>
                                <member-error></member-error>
                            </div>
                            <div class='loginErrorWrap'>
                                <input id='loginName' type="text" name='name' placeholder="請輸入您的姓名">
                                <member-error></member-error>
                            </div>
                            <div class='loginErrorWrap'>
                                <input id='loginPhone' type="text" name='phone' placeholder="請輸入您的連絡電話">
                                <member-error></member-error>
                            </div>
                            <div class='loginErrorAddress loginErrorWrap'>
                                <select class="loginSelect1" id="縣市1" name='city'></select>
                                <select class="loginSelect2" id="鄉鎮市區1" name='area'></select>
                                <input id="loginAddress" type="text" name='address' placeholder="地址">
                                <member-error></member-error>
                            </div>


                            <div class='loginCode'>
                                <div class='loginErrorWrap'>
                                    <input class='loginCodeEnter' type="text" placeholder="請輸入右方數字">
                                    <member-error></member-error>
                                </div>
                                <span class='loginC loginCodeNew'></span>
                                <i class="fas fa-sync-alt loginRefresh"></i>
                            </div>

                            <button class='loginSignupButton loginBtn' type='button' onclick="doRegister()">
                                註冊
                            </button>
                            <!-- <input class='loginSignupButton loginBtn' type='submit' onclick="doRegister()" value='註冊' style='color: black'> -->
                        </div>
                    </form>
                </div>
            </div>
            <!-- 忘記密碼============================= -->
            <div class='forgetPWD'>
                <div class='forgetFormTitle'>
                    <h4>忘記密碼</h4>
                    <div class='loginChoosenBar2'></div>
                </div>
                <div class="forgetForm">
                    <div id='forgetFormPage'>
                        <div id="loginArrow2"></div>
                        <div class='loginErrorWrap'>
                            <input class='loginAccountForget' type="text" placeholder="請輸入您的信箱">
                            <member-error></member-error>
                        </div>
                        <div class='loginCode'>
                            <div class='loginErrorWrap'>
                                <input class='loginCodeEnterForget' type="text" placeholder="請輸入右方數字">
                                <member-error></member-error>
                            </div>

                            <span class='loginC loginCodeNewForget'></span>
                            <i class="fas fa-sync-alt loginRefresh"></i>
                        </div>
                        <button class='loginSendPSW' type="submit" onclick="loginSendPassword()">
                            傳送新密碼
                        </button>
                        <div class='loginBack'>
                            <i class="fas fa-angle-left"></i>
                            <span>返回登入</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 彈出跳窗 -->
    <div class='loginpopBG'>
        <div class="type2">            
            <img src="../images/login/send_password.png" alt="">
            <h2>新密碼已寄出</h2>
            <p>系統已發送新密碼至您的指定信箱</p>
            <div>
                <a href="#" class='mainBtn loginSendPSWclose'>返回</a>
            </div>
        </div>
    </div>
    <!-- 跳窗結束 -->
    <script>
        function doRegister() { 
            let isSignupOK = [];// 註冊成功的判別  
            // 清空重來
            $('.loginError').css('display', 'none');
            $('.loginError').children('p').text('資料格式不正確');
            $('.loginAll input').css('border', '2px solid transparent');
            $('.loginAll select').css('border', '2px solid transparent');
            // 設定變數
            let account = $('.loginAccount').val();
            let password = $('#loginPassword').val();
            let password2 = $('#loginPassword2').val();
            // 性別x3
            let malecheck = $('#loginMale').is(":checked");
            let femalecheck = $('#loginFemale').is(":checked");
            let othercheck = $('#loginOther').is(":checked");

            let name = $('#loginName').val();
            let phone = $('#loginPhone').val();
            // 地址x3
            let address1 = $('.loginSelect1').val();
            let address2 = $('.loginSelect2').val();
            let address3 = $('#loginAddress').val();

            // 亂數碼
            let code = $('.loginCodeEnter').val();
            let codeRight = $('.loginCodeNew').text().substr(0, 4);

            // 正規表示法
            // email格式
            let mailRight = /^([a-zA-Z0-9_\.\-\+])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
            // 密碼格式
            let passwordRight = /^.{8,16}$/;
            // 程式開始----------------------------
            if (account == "") {
                // e.preventDefault();
                $('.loginAccount').css('border', '2px solid #dc3838');
                $('.loginAccount').next().css('display', 'inline-block');
                $('.loginAccount').next().children('p').text('請輸入資訊');
                $('.loginAccount').addClass('loginFalse');    //給登入註冊切換判斷
            } else if (!mailRight.test(account)) {
                // e.preventDefault();
                $('.loginAccount').css('border', '2px solid #dc3838');
                $('.loginAccount').next().css('display', 'inline-block');
                $('.loginAccount').addClass('loginFalse');    //給登入註冊切換判斷
            } else {
                $('.loginAccount').removeClass('loginFalse');    //給登入註冊切換判斷
                isSignupOK.push('signupOK');
            }

            if (password == "") {
                // e.preventDefault();
                $('#loginPassword').css('border', '2px solid #dc3838');
                $('#loginPassword').next().next().css('display', 'inline-block');
                $('#loginPassword').next().next().children('p').text('請輸入資訊');
                $('#loginPassword').addClass('loginFalse');    //給登入註冊切換判斷
            } else if (!passwordRight.test(password)) {
                // e.preventDefault();
                $('#loginPassword').css('border', '2px solid #dc3838');
                $('#loginPassword').next().next().css('display', 'inline-block');
                $('#loginPassword').addClass('loginFalse');    //給登入註冊切換判斷
            } else {
                isSignupOK.push('signupOK');
                $('#loginPassword').removeClass('loginFalse');    //給登入註冊切換判斷
            }

            if (password2 == "") {
                // e.preventDefault();
                $('#loginPassword2').css('border', '2px solid #dc3838');
                $('#loginPassword2').next().next().css('display', 'inline-block');
                $('#loginPassword2').next().next().children('p').text('請輸入資訊');
            } else if (password2 != password) {
                // e.preventDefault();
                $('#loginPassword2').css('border', '2px solid #dc3838');
                $('#loginPassword2').next().next().css('display', 'inline-block');
                $('#loginPassword2').next().next().children('p').text('兩次輸入密碼不同');
            } else {
                isSignupOK.push('signupOK');
            }

            if (malecheck == false && femalecheck == false && othercheck == false) {
                // e.preventDefault();
                $('.loginGender').next().css('display', 'inline-block');
                $('.loginGender').next().children('p').text('請選擇性別');
            } else {
                isSignupOK.push('signupOK');
            }

            if (name == "") {
                // e.preventDefault();
                $('#loginName').css('border', '2px solid #dc3838');
                $('#loginName').next().css('display', 'inline-block');
                $('#loginName').next().children('p').text('請輸入資訊');
            } else {
                isSignupOK.push('signupOK');
            }

            if (phone == "") {
                // e.preventDefault();
                $('#loginPhone').css('border', '2px solid #dc3838');
                $('#loginPhone').next().css('display', 'inline-block');
                $('#loginPhone').next().children('p').text('請輸入資訊');
            } else {
                isSignupOK.push('signupOK');
            }

            if (address1 == false || address2 == false || address3 == false) {
                // e.preventDefault();
                $('#loginAddress').css('border', '2px solid #dc3838');
                $('.loginSelect1').css('border', '2px solid #dc3838');
                $('.loginSelect2').css('border', '2px solid #dc3838');
                $('#loginAddress').next().css('display', 'inline-block');
                $('#loginAddress').next().children('p').text('地址請填寫完全');
            } else {
                isSignupOK.push('signupOK');
            }

            // 輸入數字
            if (code == "") {
                // e.preventDefault();
                $('.loginCodeEnter').css('border', '2px solid #dc3838');
                $('.loginCodeEnter').next().css('display', 'inline-block');
                $('.loginCodeEnter').next().children('p').text('請輸入資訊');
            } else if (code != codeRight) {
                // e.preventDefault();
                // console.log(code);
                $('.loginCodeEnter').css('border', '2px solid #dc3838');
                $('.loginCodeEnter').next().css('display', 'inline-block');
                $('.loginCodeEnter').next().children('p').text('驗證碼錯誤');
            } else {
                isSignupOK.push('signupOK');
            };

            //全部欄位判定成功
            if (isSignupOK.length == 8) {
                let gender = $('.loginGender input[type="radio"]:checked + label').text();
                if(gender =='男性'){
                    gender = '男';
                }else if(gender = '女性'){
                    gender = '女';
                }else{
                    gender = '第三性';
                };

                $('#loginFormPage').attr('action','../php/register.php');
                $.ajax({
                    method: 'POST',
                    url: '../php/register.php',
                    data: {
                        account : $('.loginAccount').val(),
                        password: $('.psw').val(),
                        name: $('#loginName').val(),
                        gender: gender,
                        phone: $('#loginPhone').val(),
                        city: $('.loginSelect1').val(),
                        area: $('.loginSelect2').val(),
                        address: $('#loginAddress').val(),
                    },
                    dataType: 'text',
                    success: function (data) {
                        if(data == '1'){
                            $('.type2 > h2').text('註冊成功');
                            $('.type2 > p').text('請重新登入');
                            $('.type2 a').text('前往');
                            $('.loginpopBG').show();
                        }else{
                            $('.type2 > h2').text('註冊失敗');
                            $('.type2 > p').text('此信箱已被使用，請重新註冊');
                            $('.loginSendPSWclose').attr('href','#')
                            $('.loginpopBG').show();
                        }
                        
                    },
                    error: function (exception) {
                        alert("數據載入失敗: " + exception.status);
                    }
                })
            }
        };
    </script>
    <script>
        function doLogin(){
            $.ajax({
                method: 'POST',
                url: '../php/login.php',
                data: {
                    account : $('.loginAccount').val(),
                    password: $('.psw').val(),
                },
                dataType: 'text',
                success: function (data) {
                    // 先判斷帳號密碼是否符合格式
                    let loginDataRight = [];
                    // 設定變數
                    let account = $('.loginAccount').val();
                    let password = $('#loginPassword').val();
                    // 正規表示法
                    // email格式
                    let mailRight = /^([a-zA-Z0-9_\.\-\+])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
                    // 密碼格式
                    let passwordRight = /^.{8,16}$/;

                    if(account == ""){
                        // e.preventDefault();
                        $('.loginAccount').css('border','2px solid #dc3838');
                        $('.loginAccount').next().css('display','inline-block');
                        $('.loginAccount').next().children('p').text('請輸入資訊');
                    }else if(!mailRight.test(account)){
                        // e.preventDefault();
                        $('.loginAccount').css('border','2px solid #dc3838');
                        $('.loginAccount').next().css('display','inline-block');
                    }else{
                        loginDataRight.push('loginRight');         
                    };

                    if(password == ""){
                        // e.preventDefault();
                        $('#loginPassword').css('border','2px solid #dc3838');
                        $('#loginPassword').next().next().css('display','inline-block');
                        $('#loginPassword').next().next().children('p').text('請輸入資訊');
                    }else if(!passwordRight.test(password)){
                        // e.preventDefault();
                        $('#loginPassword').css('border','2px solid #dc3838');
                        $('#loginPassword').next().next().css('display','inline-block');
                    }else{
                        loginDataRight.push('loginRight');
                    };

                    // console.log(loginDataRight.length);
                    // 帳號跟密碼符合以上js格式後，才送PHP
                    if( loginDataRight.length == 2){
                        if(data != '0'){
                            data = JSON.parse(data)[0];
                            let account = data['account'];
                            let status = data['member_status'];
                            if(status ==0){
                                $('.type2 > h2').text('登入失敗');
                                $('.type2 > p').text('您的帳號已停用，請聯絡我們');
                                $('.loginpopBG').show();
                            }else{
                                if($('#loginKeeplog').is(':checked')){
                                localStorage.setItem('account',  account);
                                }else{
                                    sessionStorage.setItem('account',  account);
                                }
                                window.location.reload();
                            }
                            
                        }else{
                            $('.type2 > h2').text('登入失敗');
                            $('.type2 > p').text('帳號或密碼錯誤');
                            // $('.loginSendPSWclose').attr('href','login.html')
                            $('.loginpopBG').show();
                        };           
                    };
                    
                },
                error: function (exception) {
                    alert("數據載入失敗: " + exception.status);
                }
            })
        };

        function loginSendPassword(){
            $.ajax({
                method: 'POST',
                url: '../php/loginSendPassword.php',
                data: {
                    account : $('.loginAccountForget').val(),
                },
                dataType: 'text',
                success: function (data) {
                    console.log('start');
                    // 確認是否符合規範
                    // 清空重來
                    $('.loginError').css('display','none');
                    $('.loginError').children('p').text('資料格式不正確');
                    $('.loginAll input').css('border','2px solid transparent');
                    
                    let accountForget = $('.loginAccountForget').val();
                    let codeForget = $('.loginCodeEnterForget').val();
                    let codeRightForget = $('.loginCodeNewForget').text().substr(0,4);

                    // 正規表示法
                    // email格式
                    let mailRight = /^([a-zA-Z0-9_\.\-\+])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;

                    // 忘記密碼
                    if(accountForget == ""){
                        // e.preventDefault();
                        $('.loginAccountForget').css('border','2px solid #dc3838');
                        $('.loginAccountForget').next().css('display','inline-block');
                        $('.loginAccountForget').next().children('p').text('請輸入資訊');
                        $('.loginAccountForget').addClass('loginWrong');   //給忘記密碼的彈窗判斷
                    }else if(!mailRight.test(accountForget)){
                        // e.preventDefault();
                        $('.loginAccountForget').css('border','2px solid #dc3838');
                        $('.loginAccountForget').next().css('display','inline-block');
                        $('.loginAccountForget').addClass('loginWrong');   //給忘記密碼的彈窗判斷
                    }else{
                        $('.loginAccountForget').removeClass('loginWrong');   //給忘記密碼的彈窗判斷
                    }

                    if(codeForget == ""){
                        // e.preventDefault();
                        $('.loginCodeEnterForget').css('border','2px solid #dc3838');
                        $('.loginCodeEnterForget').next().css('display','inline-block');
                        $('.loginCodeEnterForget').next().children('p').text('請輸入資訊');
                        $('.loginCodeEnterForget').addClass('loginWrong');   //給忘記密碼的彈窗判斷
                    }else if( codeForget != codeRightForget ){
                        // e.preventDefault();
                        $('.loginCodeEnterForget').css('border','2px solid #dc3838');
                        $('.loginCodeEnterForget').next().css('display','inline-block');
                        $('.loginCodeEnterForget').next().children('p').text('驗證碼錯誤');
                        $('.loginCodeEnterForget').addClass('loginWrong');    //給忘記密碼的彈窗判斷
                    }else{
                        $('.loginCodeEnterForget').removeClass('loginWrong');    //給忘記密碼的彈窗判斷
                    };
                    
                    // 確認是否有錯誤通知
                    if( $('.loginAccountForget').hasClass('loginWrong') || $('.loginCodeEnterForget').hasClass('loginWrong')){
                        
                    }else{
                        // 如果點擊時，沒有錯誤通知，則送PHP
                        if( data != 0 ){
                            // mail正確
                            $('.type2 > h2').text('新密碼已寄出');
                            $('.type2 > p').text('系統已發送新密碼至您的指定信箱');
                            $('.loginpopBG').show();
                            let pwd = JSON.parse(data)[0].password;
                            let body = `您的密碼為${pwd}，請盡速至會員中心更換您的密碼。`;
                            // 寄信
                            Email.send({
                                SecureToken : "3ad594-3f7c-49dc-9a72-720bb6b58fa6",
                                Host : "smtp.elasticemail.com",
                                Username : "romanlee821116@gmail.com",
                                Password : "6DFB4A34831E82E8F7625B65028BA55A62E0",
                                // Password : "roman122715386",
                                To : 'roman821116@gmail.com',
                                From : "romanlee821116@gmail.com",
                                Subject : "您的登入密碼 - 小春堂",
                                Body : body
                            }).then(
                            // message => alert('test'),
                            );

                        }else{
                            // mail錯誤
                            $('.type2 > h2').text('帳號錯誤');
                            $('.type2 > p').text('請確認後重新輸入');
                            $('.loginpopBG').show();
                        }
                        
                    };
                },
                error: function (exception) {
                    alert("數據載入失敗: " + exception.status);
                }
            })
        };
    </script>

</body>

</html>